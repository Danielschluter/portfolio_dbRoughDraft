
<!DOCTYPE html>
<html>
<head>
  <title>Return Contribution Analysis</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
  <div class="menu-icon" onclick="toggleMenu()">â˜° Menu</div>

  <div class="sidebar">
    <a href="index.php">Home</a>
    <a href="calcperf.php">Calculate Performance</a>
    <a href="performance.html">Performance Reports</a>
    <a href="performance_results.html">Performance Results</a>
    <a href="return_contribution.html">Return Contribution</a>
    <a href="holdings.html">Holdings</a>
    <a href="pivot.html">Analysis</a>
    <a href="edgardata.html">Edgar Data</a>
    <a href="risk.html">Risk Metrics</a>
  </div>

  <div class="content">
    <h1>Return Contribution Analysis</h1>
    
    <div class="accounts-container" style="margin-bottom: 20px;">
      <h2 style="margin-bottom: 15px; color: #333;">Select Account and Period</h2>
      
      <div class="date-controls" style="margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
        <div class="control-group">
          <label for="accountSelect" class="control-label">Account:</label>
          <select id="accountSelect" class="control-input">
            <option value="">Select an account...</option>
          </select>
        </div>

        <div class="control-group">
          <label for="startDate" class="control-label">Start Date:</label>
          <input type="date" id="startDate" class="control-input date-input" value="2023-01-01">
        </div>

        <div class="control-group">
          <label for="endDate" class="control-label">End Date:</label>
          <input type="date" id="endDate" class="control-input">
        </div>

        <div class="control-group">
          <button id="analyzeBtn" class="btn btn-primary">Analyze Contributions</button>
        </div>
      </div>
    </div>

    <div id="loading" class="loading" style="display: none;">Loading contribution data...</div>
    <div id="error" class="error" style="display: none;"></div>

    <!-- Summary Cards -->
    <div id="summary-container" style="display: none;">
      <div class="summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <div class="summary-card">
          <h3>Portfolio Return</h3>
          <div id="portfolioReturn" class="metric-value">--</div>
        </div>
        <div class="summary-card">
          <h3>Top Contributor</h3>
          <div id="topContributor" class="metric-value">--</div>
        </div>
        <div class="summary-card">
          <h3>Worst Performer</h3>
          <div id="worstPerformer" class="metric-value">--</div>
        </div>
        <div class="summary-card">
          <h3>Number of Holdings</h3>
          <div id="numHoldings" class="metric-value">--</div>
        </div>
      </div>
    </div>

    <!-- Chart Container -->
    <div id="chart-container" style="display: none; margin-bottom: 20px;">
      <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h3>Return Contribution Waterfall</h3>
        <div id="waterfall-chart" style="width: 100%; height: 400px;"></div>
      </div>
      
      <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3>Contribution Breakdown</h3>
        <div id="pie-chart" style="width: 100%; height: 400px;"></div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="tbl-container" style="display: none; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3>Detailed Contribution Analysis</h3>
      <div class="header-row" id="dynamicHeader"></div>
      <div class="virtual-scroll-content"></div>
    </div>
  </div>

  <script>
    class VirtualScroll {
      constructor(container, data) {
        this.container = container;
        container.__virtualScroll = this;
        this.itemHeight = 35;
        this.content = container.querySelector('.virtual-scroll-content');
        this.originalData = data;
        this.data = [...data];
        this.totalItems = data.length;
        this.visibleItems = Math.ceil(container.clientHeight / this.itemHeight);
        this.cachedRows = new Map();
        this.sortColumn = null;
        this.sortAscending = true;

        this.setupScroll();
        this.setupSorting();
        this.render();

        this.container.addEventListener('scroll', () => {
          window.requestAnimationFrame(() => this.render());
        });
      }

      setupSorting() {
        const headers = this.container.querySelectorAll('.header-row > div');
        headers.forEach((header, index) => {
          header.style.cursor = 'pointer';
          header.addEventListener('click', () => this.sort(index));
        });
      }

      sort(columnIndex) {
        const headers = Array.from(this.container.querySelectorAll('.header-row > div'));
        const columnKey = headers[columnIndex].textContent;

        if (this.sortColumn === columnKey) {
          this.sortAscending = !this.sortAscending;
        } else {
          this.sortColumn = columnKey;
          this.sortAscending = true;
        }

        this.data.sort((a, b) => {
          const valueA = a[columnKey];
          const valueB = b[columnKey];

          if (!isNaN(valueA) && !isNaN(valueB)) {
            return this.sortAscending ? valueA - valueB : valueB - valueA;
          }

          const comparison = String(valueA).localeCompare(String(valueB));
          return this.sortAscending ? comparison : -comparison;
        });

        this.cachedRows.clear();
        this.render();
      }

      createRow(rowData, index) {
        if (this.cachedRows.has(index)) {
          return this.cachedRows.get(index);
        }

        const row = document.createElement('div');
        row.className = 'div-row';

        for (let x in rowData) {
          const cell = document.createElement('div');
          let cellValue = rowData[x];

          // Format numeric values
          if (!isNaN(cellValue) && cellValue !== null && cellValue !== '') {
            const num = parseFloat(cellValue);
            if (x === 'weight' || x === 'contribution_percent') {
              cellValue = (num * 100).toFixed(2) + '%';
            } else if (x === 'total_return' || x === 'contribution_bps') {
              cellValue = num.toFixed(2);
            } else if (x === 'market_value' || x === 'cost_basis' || x === 'contribution_dollar') {
              cellValue = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
              }).format(num);
            }
          }

          cell.textContent = cellValue;
          row.appendChild(cell);
        }

        this.cachedRows.set(index, row);
        return row;
      }

      setupScroll() {
        this.content.style.height = `${this.totalItems * this.itemHeight}px`;
      }

      render() {
        const scrollTop = this.container.scrollTop;
        const startIndex = Math.floor(scrollTop / this.itemHeight);
        const endIndex = Math.min(startIndex + this.visibleItems + 2, this.totalItems);

        this.content.innerHTML = '';

        for(let i = startIndex; i < endIndex; i++) {
          if (i >= 0 && i < this.data.length) {
            const row = this.createRow(this.data[i], i);
            row.style.position = 'absolute';
            row.style.top = `${i * this.itemHeight}px`;
            row.style.width = '100%';
            this.content.appendChild(row);
          }
        }
      }
    }

    // Load accounts on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadAccounts();
      document.getElementById('endDate').valueAsDate = new Date();
      
      document.getElementById('analyzeBtn').addEventListener('click', function() {
        const accountNum = document.getElementById('accountSelect').value;
        if (accountNum) {
          loadReturnContribution(accountNum);
        } else {
          showError('Please select an account first');
        }
      });
    });

    function loadAccounts() {
      fetch('scripts/loadaccounts.php')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(accounts => {
          const select = document.getElementById('accountSelect');
          accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.acct_num;
            option.textContent = account.acct_num;
            select.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Error loading accounts:', error);
          showError('Error loading accounts');
        });
    }

    function loadReturnContribution(accountNum) {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      // Clear previous data
      document.getElementById('summary-container').style.display = 'none';
      document.getElementById('chart-container').style.display = 'none';
      document.querySelector('.tbl-container').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('loading').style.display = 'block';

      // Build URL with parameters
      let url = `return_contribution_query.php?acct_num=${accountNum}`;
      if (startDate) url += `&start_date=${startDate}`;
      if (endDate) url += `&end_date=${endDate}`;

      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          document.getElementById('loading').style.display = 'none';
          
          if (data && data.length > 0) {
            displaySummary(data);
            createCharts(data);
            createDataTable(data);
            
            document.getElementById('summary-container').style.display = 'block';
            document.getElementById('chart-container').style.display = 'block';
            document.querySelector('.tbl-container').style.display = 'block';
          } else {
            showError('No data found for account ' + accountNum);
          }
        })
        .catch(error => {
          document.getElementById('loading').style.display = 'none';
          console.error('Error fetching data:', error);
          showError('Error loading data: ' + error.message);
        });
    }

    function displaySummary(data) {
      // Calculate summary metrics
      const totalReturn = data.reduce((sum, item) => sum + parseFloat(item.contribution_bps || 0), 0);
      const sortedByContribution = [...data].sort((a, b) => parseFloat(b.contribution_bps || 0) - parseFloat(a.contribution_bps || 0));
      
      const topContributor = sortedByContribution[0];
      const worstPerformer = sortedByContribution[sortedByContribution.length - 1];

      document.getElementById('portfolioReturn').textContent = `${totalReturn.toFixed(2)} bps`;
      document.getElementById('topContributor').innerHTML = `${topContributor.ticker}<br><span style="color: #28a745; font-size: 0.8em;">+${parseFloat(topContributor.contribution_bps).toFixed(2)} bps</span>`;
      document.getElementById('worstPerformer').innerHTML = `${worstPerformer.ticker}<br><span style="color: #dc3545; font-size: 0.8em;">${parseFloat(worstPerformer.contribution_bps).toFixed(2)} bps</span>`;
      document.getElementById('numHoldings').textContent = data.length;
    }

    function createCharts(data) {
      createWaterfallChart(data);
      createPieChart(data);
    }

    function createWaterfallChart(data) {
      const sortedData = [...data].sort((a, b) => parseFloat(b.contribution_bps) - parseFloat(a.contribution_bps));
      
      const categories = sortedData.map(item => item.ticker);
      const contributions = sortedData.map(item => parseFloat(item.contribution_bps));

      const options = {
        series: [{
          name: 'Contribution (bps)',
          data: contributions.map((value, index) => ({
            x: categories[index],
            y: value,
            fillColor: value >= 0 ? '#28a745' : '#dc3545'
          }))
        }],
        chart: {
          type: 'bar',
          height: 400
        },
        plotOptions: {
          bar: {
            columnWidth: '60%',
            distributed: true
          }
        },
        dataLabels: {
          enabled: true,
          formatter: function(val) {
            return val.toFixed(1) + ' bps';
          }
        },
        title: {
          text: 'Individual Ticker Contribution to Portfolio Return',
          align: 'center'
        },
        xaxis: {
          categories: categories,
          labels: {
            rotate: -45,
            style: {
              fontSize: '12px'
            }
          }
        },
        yaxis: {
          title: {
            text: 'Contribution (basis points)'
          }
        },
        legend: {
          show: false
        }
      };

      const chart = new ApexCharts(document.querySelector("#waterfall-chart"), options);
      chart.render();
    }

    function createPieChart(data) {
      // Only show positive contributors in pie chart
      const positiveContributors = data.filter(item => parseFloat(item.contribution_bps) > 0);
      
      const series = positiveContributors.map(item => parseFloat(item.contribution_bps));
      const labels = positiveContributors.map(item => item.ticker);

      const options = {
        series: series,
        chart: {
          type: 'pie',
          height: 400
        },
        labels: labels,
        title: {
          text: 'Positive Contributors Distribution',
          align: 'center'
        },
        dataLabels: {
          enabled: true,
          formatter: function(val, opts) {
            const contribution = series[opts.seriesIndex];
            return opts.w.config.labels[opts.seriesIndex] + '\n' + contribution.toFixed(1) + ' bps';
          }
        },
        legend: {
          position: 'bottom'
        }
      };

      const chart = new ApexCharts(document.querySelector("#pie-chart"), options);
      chart.render();
    }

    function createDataTable(data) {
      if (!data || data.length === 0) return;

      // Create header columns
      const headerRow = document.getElementById('dynamicHeader');
      headerRow.innerHTML = '';
      
      const headers = Object.keys(data[0]);
      headers.forEach(header => {
        const headerDiv = document.createElement('div');
        headerDiv.textContent = header.replace(/_/g, ' ').toUpperCase();
        headerDiv.style.cursor = 'pointer';
        headerRow.appendChild(headerDiv);
      });

      // Create virtual scroll table
      const container = document.querySelector('.tbl-container');
      if (container.__virtualScroll) {
        container.__virtualScroll = null;
      }
      new VirtualScroll(container, data);
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').textContent = message;
      document.getElementById('error').style.display = 'block';
    }

    // Toggle menu function (reused from other pages)
    function toggleMenu() {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('show');

      if (sidebar.classList.contains('show')) {
        document.addEventListener('click', closeMenuOutside);
      } else {
        document.removeEventListener('click', closeMenuOutside);
      }
    }

    function closeMenuOutside(event) {
      const sidebar = document.querySelector('.sidebar');
      const menuIcon = document.querySelector('.menu-icon');

      if (!sidebar.contains(event.target) && !menuIcon.contains(event.target)) {
        sidebar.classList.remove('show');
        document.removeEventListener('click', closeMenuOutside);
      }
    }

    // Close menu when clicking on a link
    document.querySelectorAll('.sidebar a').forEach(link => {
      link.addEventListener('click', () => {
        document.querySelector('.sidebar').classList.remove('show');
        document.removeEventListener('click', closeMenuOutside);
      });
    });
  </script>

  <style>
    .summary-card {
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .summary-card h3 {
      margin: 0 0 10px 0;
      color: #374151;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      font-family: 'Monaco', 'Menlo', monospace;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .control-label {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }

    .control-input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }
  </style>
</body>
</html>
