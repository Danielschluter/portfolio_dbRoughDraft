<!DOCTYPE html>
<html>
<head>
  <title>Performance Query Results</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
  <div class="menu-icon" onclick="toggleMenu()">â˜° Menu</div>

  <div class="sidebar">
    <a href="index.php">Home</a>
    <a href="calcperf.php">Calculate Performance</a>
    <a href="performance.html">Performance Reports</a>
    <a href="performance_results.html">Performance Results</a>
    <a href="holdings.html">Holdings</a>
    <a href="pivot.html">Analysis</a>
    <a href="edgardata.html">Edgar Data</a>
    <a href="risk.html">Risk Metrics</a>
  </div>

  <div class="content">
    <h1>Performance Query Results</h1>

    <div class="accounts-container" style="margin-bottom: 20px;">
      <h2 style="margin-bottom: 15px; color: #333;">Select an Account to View Performance</h2>
      
      <div class="date-controls" style="margin-bottom: 20px; display: flex; gap: 20px; align-items: center;">
        <div class="control-group">
          <label for="startDate" class="control-label">Start Date:</label>
          <div class="date-input-group">
            <input type="date" id="startDate" class="control-input date-input" value="2024-09-30">
            <button id="inceptionBtn" type="button" class="inception-btn">Use Inception Date</button>
          </div>
        </div>

        <div class="control-group">
          <label for="endDate" class="control-label">End Date:</label>
          <input type="date" id="endDate" class="control-input" value="2025-07-31">
        </div>
      </div>

      <div id="accountsTable" class="accounts-table" style="background: white; border-radius: var(--border-radius); padding: var(--space-4); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
        <div class="loading" style="text-align: center; padding: 20px; color: #666;">Loading accounts...</div>
      </div>
    </div>

  <div id="loading" class="loading" style="display: none;">Loading data...</div>
  <div id="error" class="error" style="display: none;"></div>

  <div id="chart-container" style="display: none; margin-bottom: 20px; background: white; border-radius: var(--border-radius); padding: var(--space-4); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
    <div id="performance-chart" style="width: 100%; height: 400px;"></div>
  </div>

  <!-- Holdings Analysis Deep Dive Section -->
  <div id="holdings-analysis-container" style="display: none; margin-bottom: 20px;">
    <div style="background: white; border-radius: var(--border-radius); padding: var(--space-4); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #333;">Holdings Analysis Deep Dive</h2>
        <button id="toggleHoldingsAnalysis" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          Show Analysis
        </button>
      </div>
      
      <div id="holdings-analysis-content" style="display: none;">
        <div id="holdings-loading" style="text-align: center; padding: 20px; color: #666;">Loading holdings analysis...</div>
        <div id="holdings-error" style="display: none; text-align: center; padding: 20px; color: #d32f2f; background-color: #ffebee; border-radius: 4px;">Error loading holdings analysis</div>
        
        <!-- Summary Cards -->
        <div id="holdings-summary" style="display: none; margin-bottom: 30px;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="metric-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #007bff;" id="totalHoldings">-</div>
              <div style="color: #666; font-size: 14px;">Total Holdings</div>
            </div>
            <div class="metric-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="bestPerformer">-</div>
              <div style="color: #666; font-size: 14px;">Best Performer</div>
            </div>
            <div class="metric-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #dc3545;" id="worstPerformer">-</div>
              <div style="color: #666; font-size: 14px;">Worst Performer</div>
            </div>
            <div class="metric-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #6f42c1;" id="avgHoldingPeriod">-</div>
              <div style="color: #666; font-size: 14px;">Avg Days Held</div>
            </div>
          </div>
        </div>

        <!-- Holdings Analysis Table -->
        <div id="holdings-analysis-table" style="display: none;">
          <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
            <input type="text" id="holdingsFilter" placeholder="Filter by ticker..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
            <select id="holdingsSortBy" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="starting_value">Sort by Starting Value</option>
              <option value="total_return_pct">Sort by Total Return %</option>
              <option value="market_value_change_pct">Sort by Market Value Change %</option>
              <option value="price_change_pct">Sort by Price Change %</option>
              <option value="days_held_in_period">Sort by Days Held</option>
              <option value="total_return">Sort by Total Return</option>
            </select>
          </div>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif; font-size: 14px;">
              <thead>
                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                  <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Ticker</th>
                  <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">First Date</th>
                  <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">Last Date</th>
                  <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Days Held</th>
                  <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Starting Value</th>
                  <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Ending Value</th>
                  <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Market Value Change</th>
                  <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Price Change %</th>
                  <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Transactions</th>
                  <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Net Cash Flow</th>
                  <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Total Return</th>
                  <th style="padding: 10px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Total Return %</th>
                </tr>
              </thead>
              <tbody id="holdingsAnalysisTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tbl-container" style="display: none;">
    <div class="header-row" id="dynamicHeader"></div>
    <div class="virtual-scroll-content"></div>
  </div>

  <!-- Holdings Modal -->
  <div id="holdingsModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
        <h2 id="modalTitle" style="margin: 0; color: #333;">Holdings as of Date</h2>
        <span class="close" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">&times;</span>
      </div>
      <div id="holdingsContent">
        <div id="holdingsLoading" style="text-align: center; padding: 20px; color: #666;">Loading holdings...</div>
        <div id="holdingsError" style="display: none; text-align: center; padding: 20px; color: #d32f2f; background-color: #ffebee; border-radius: 4px;">Error loading holdings</div>
        <div id="holdingsTable" style="display: none;">
          <table style="width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif;">
            <thead>
              <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Ticker</th>
                <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Shares</th>
                <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Price</th>
                <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Market Value</th>
              </tr>
            </thead>
            <tbody id="holdingsTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    class VirtualScroll {
      constructor(container, data) {
        this.container = container;
        container.__virtualScroll = this;
        this.itemHeight = 35;
        this.content = container.querySelector('.virtual-scroll-content');
        this.originalData = data;
        this.data = [...data];
        this.totalItems = data.length;
        this.visibleItems = Math.ceil(container.clientHeight / this.itemHeight);
        this.cachedRows = new Map();
        this.sortColumn = null;
        this.sortAscending = true;

        this.setupScroll();
        this.setupSorting();
        this.render();

        this.container.addEventListener('scroll', () => {
          window.requestAnimationFrame(() => this.render());
        });
      }

      setupSorting() {
        const headers = this.container.querySelectorAll('.header-row > div');
        headers.forEach((header, index) => {
          header.style.cursor = 'pointer';
          header.addEventListener('click', () => this.sort(index));
        });
      }

      sort(columnIndex) {
        const headers = Array.from(this.container.querySelectorAll('.header-row > div'));
        const columnKey = headers[columnIndex].textContent;

        if (this.sortColumn === columnKey) {
          this.sortAscending = !this.sortAscending;
        } else {
          this.sortColumn = columnKey;
          this.sortAscending = true;
        }

        this.data.sort((a, b) => {
          const valueA = a[columnKey];
          const valueB = b[columnKey];

          if (!isNaN(valueA) && !isNaN(valueB)) {
            return this.sortAscending ? valueA - valueB : valueB - valueA;
          }

          const comparison = String(valueA).localeCompare(String(valueB));
          return this.sortAscending ? comparison : -comparison;
        });

        this.cachedRows.clear();
        this.render();
      }

      createRow(rowData, index) {
        if (this.cachedRows.has(index)) {
          return this.cachedRows.get(index);
        }

        const row = document.createElement('div');
        row.className = 'div-row';

        let cellIndex = 0;
        for (let x in rowData) {
          const cell = document.createElement('div');
          let cellValue = rowData[x];

          // Make date cells clickable
          if (x === 'date') {
            cell.style.cursor = 'pointer';
            cell.style.color = '#007bff';
            cell.style.textDecoration = 'underline';
            cell.addEventListener('click', () => {
              // Get account number from the currently loaded data context
              const currentAccount = window.currentAccount || 'Unknown';
              showHoldingsModal(cellValue, currentAccount);
            });
          }

          // Format numeric values
          if (!isNaN(cellValue) && cellValue !== null && cellValue !== '') {
            const num = parseFloat(cellValue);
            //console.log(x);
            if (x == 'pct_return' || x == 'spy_pct_return') {
              cellValue = (num * 100).toFixed(2) + '%';
            } else {
              cellValue = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
              }).format(num);
            }

          }

          cell.textContent = cellValue;
          row.appendChild(cell);
          cellIndex++;
        }

        this.cachedRows.set(index, row);
        return row;
      }

      setupScroll() {
        this.content.style.height = `${this.totalItems * this.itemHeight}px`;
      }

      render() {
        const scrollTop = this.container.scrollTop;
        const startIndex = Math.floor(scrollTop / this.itemHeight);
        const endIndex = Math.min(startIndex + this.visibleItems + 2, this.totalItems);

        this.content.innerHTML = '';

        for(let i = startIndex; i < endIndex; i++) {
          if (i >= 0 && i < this.data.length) {
            const row = this.createRow(this.data[i], i);
            row.style.position = 'absolute';
            row.style.top = `${i * this.itemHeight}px`;
            row.style.width = '100%';
            this.content.appendChild(row);
          }
        }
      }
    }

    function createHeaderColumns(data) {
      if (!data || data.length === 0) return;

      const headerRow = document.getElementById('dynamicHeader');
      const firstRow = data[0];

      Object.keys(firstRow).forEach(key => {
        const headerDiv = document.createElement('div');
        headerDiv.textContent = key;
        headerRow.appendChild(headerDiv);
      });
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').textContent = message;
      document.getElementById('error').style.display = 'block';
    }

    function createChart(data) {
      const dates = data.map(row => row.date);

      // Calculate growth of $10,000 based on percentage returns
      let portfolioValues = [];
      let spyValues = [];
      let portfolioValue = 10000;
      let spyValue = 10000;
      let portfolioReturns = [];
      let spyReturns = [];

      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        const portfolioReturn = parseFloat(row.pct_return) || 0;
        const spyReturn = parseFloat(row.spy_pct_return) || 0;

        portfolioReturns.push(portfolioReturn);
        spyReturns.push(spyReturn);

        // Calculate new values based on previous value and return
        portfolioValue = portfolioValue * (1 + portfolioReturn);
        spyValue = spyValue * (1 + spyReturn);

        portfolioValues.push(portfolioValue);
        spyValues.push(spyValue);
      }

      // Calculate metrics
      const metrics = calculateMetrics(portfolioValues, spyValues, portfolioReturns, spyReturns);
      displayMetrics(metrics);

      const options = {
        series: [{
          name: 'Portfolio ($10,000 Growth)',
          data: portfolioValues
        }, {
          name: 'SPY ($10,000 Growth)',
          data: spyValues
        }],
        chart: {
          type: 'line',
          height: 400,
          zoom: {
            enabled: true
          }
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          curve: 'smooth',
          width: 2
        },
        title: {
          text: 'Growth of $10,000 - Portfolio vs SPY',
          align: 'center'
        },
        xaxis: {
          categories: dates,
          type: 'datetime',
          labels: {
            rotate: -45,
            style: {
              fontSize: '12px'
            }
          }
        },
        yaxis: {
          labels: {
            formatter: function(val) {
              return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
              }).format(val);
            }
          }
        },
        colors: ['#008FFB', '#00E396'],
        legend: {
          position: 'top',
          horizontalAlign: 'right',
          floating: true,
          offsetY: -25,
          offsetX: -5
        },
        tooltip: {
          x: {
            format: 'MMM dd, yyyy'
          },
          y: {
            formatter: function(value) {
              return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
              }).format(value);
            }
          }
        }
      };

      const chart = new ApexCharts(document.querySelector("#performance-chart"), options);
      chart.render();
    }

    function calculateMetrics(portfolioValues, spyValues, portfolioReturns, spyReturns) {
      // Calculate CAGR
      const portfolioFirstVal = portfolioValues[0];
      const portfolioLastVal = portfolioValues[portfolioValues.length - 1];
      const spyFirstVal = spyValues[0];
      const spyLastVal = spyValues[spyValues.length - 1];
      const years = portfolioValues.length / 252; // Assuming daily data, 252 trading days per year

      const portfolioCagr = (Math.pow(portfolioLastVal / portfolioFirstVal, 1 / years) - 1) * 100;
      const spyCagr = (Math.pow(spyLastVal / spyFirstVal, 1 / years) - 1) * 100;

      // Calculate standard deviation (annualized)
      const portfolioStdDev = calculateStandardDeviation(portfolioReturns) * Math.sqrt(252) * 100;
      const spyStdDev = calculateStandardDeviation(spyReturns) * Math.sqrt(252) * 100;

      // Calculate Sharpe ratio (assuming 0% risk-free rate)
      const portfolioSharpe = portfolioCagr / portfolioStdDev;
      const spySharpe = spyCagr / spyStdDev;

      return {
        portfolio: {
          cagr: portfolioCagr,
          stdDev: portfolioStdDev,
          sharpe: portfolioSharpe,
          finalValue: portfolioLastVal
        },
        spy: {
          cagr: spyCagr,
          stdDev: spyStdDev,
          sharpe: spySharpe,
          finalValue: spyLastVal
        }
      };
    }

    function calculateStandardDeviation(returns) {
      const mean = returns.reduce((sum, ret) => sum + ret, 0) / returns.length;
      const variance = returns.reduce((sum, ret) => sum + Math.pow(ret - mean, 2), 0) / returns.length;
      return Math.sqrt(variance);
    }

    function displayMetrics(metrics) {
      const metricsHtml = `
        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">Performance Metrics</h3>
          <table style="width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif;">
            <thead>
              <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Metric</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600; color: #008FFB;">Portfolio</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600; color: #00E396;">SPY Benchmark</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600; color: #856404;">Difference</th>
              </tr>
            </thead>
            <tbody>
              <tr style="background-color: #fff;">
                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 500;">CAGR</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.portfolio.cagr.toFixed(2)}%</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.spy.cagr.toFixed(2)}%</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${(metrics.portfolio.cagr - metrics.spy.cagr) > 0 ? '#28a745' : '#dc3545'};">${(metrics.portfolio.cagr - metrics.spy.cagr) > 0 ? '+' : ''}${(metrics.portfolio.cagr - metrics.spy.cagr).toFixed(2)}%</td>
              </tr>
              <tr style="background-color: #f8f9fa;">
                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 500;">Volatility</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.portfolio.stdDev.toFixed(2)}%</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.spy.stdDev.toFixed(2)}%</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${(metrics.portfolio.stdDev - metrics.spy.stdDev) > 0 ? '+' : ''}${(metrics.portfolio.stdDev - metrics.spy.stdDev).toFixed(2)}%</td>
              </tr>
              <tr style="background-color: #fff;">
                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 500;">Sharpe Ratio</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.portfolio.sharpe.toFixed(2)}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.spy.sharpe.toFixed(2)}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${(metrics.portfolio.sharpe - metrics.spy.sharpe) > 0 ? '#28a745' : '#dc3545'};">${(metrics.portfolio.sharpe - metrics.spy.sharpe) > 0 ? '+' : ''}${(metrics.portfolio.sharpe - metrics.spy.sharpe).toFixed(2)}</td>
              </tr>
              <tr style="background-color: #f8f9fa;">
                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 500;">Final Value</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(metrics.portfolio.finalValue)}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(metrics.spy.finalValue)}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${(metrics.portfolio.finalValue - metrics.spy.finalValue) > 0 ? '#28a745' : '#dc3545'};">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(metrics.portfolio.finalValue - metrics.spy.finalValue)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;

      let metricsDiv = document.getElementById('metrics-container');
      if (!metricsDiv) {
        metricsDiv = document.createElement('div');
        metricsDiv.id = 'metrics-container';
        // Insert metrics after chart but before data table
        const dataTable = document.querySelector('.tbl-container');
        dataTable.parentNode.insertBefore(metricsDiv, dataTable);
      }
      metricsDiv.innerHTML = metricsHtml;
    }

    // Load accounts on page load
    loadAccounts();

    // Add event listener for inception date button
    document.getElementById('inceptionBtn').addEventListener('click', loadInceptionDate);

    function loadAccounts() {
      fetch('scripts/loadaccounts.php')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(accounts => {
          displayAccountsTable(accounts);
        })
        .catch(error => {
          console.error('Error loading accounts:', error);
          document.getElementById('accountsTable').innerHTML = '<div class="error" style="text-align: center; padding: 20px; color: #d32f2f;">Error loading accounts</div>';
        });
    }

    function displayAccountsTable(accounts) {
      const container = document.getElementById('accountsTable');
      
      if (!accounts || accounts.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No accounts found</div>';
        return;
      }

      // Create table HTML
      let tableHtml = `
        <table style="width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif;">
          <thead>
            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
              <th style="padding: 15px; text-align: left; border: 1px solid #dee2e6; font-weight: 600; font-size: 16px;">Account Number</th>
              <th style="padding: 15px; text-align: center; border: 1px solid #dee2e6; font-weight: 600; font-size: 16px;">Action</th>
            </tr>
          </thead>
          <tbody>
      `;

      accounts.forEach(account => {
        tableHtml += `
          <tr class="account-row" data-account="${account.acct_num}" style="cursor: pointer; transition: background-color 0.2s;">
            <td style="padding: 15px; border: 1px solid #dee2e6; font-size: 16px; font-weight: 500;">${account.acct_num}</td>
            <td style="padding: 15px; border: 1px solid #dee2e6; text-align: center;">
              <button class="view-performance-btn" data-account="${account.acct_num}" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
                View Performance
              </button>
            </td>
          </tr>
        `;
      });

      tableHtml += `
          </tbody>
        </table>
      `;

      container.innerHTML = tableHtml;

      // Add click event listeners to rows and buttons
      document.querySelectorAll('.account-row').forEach(row => {
        row.addEventListener('mouseenter', function() {
          this.style.backgroundColor = '#f8f9fa';
        });
        
        row.addEventListener('mouseleave', function() {
          this.style.backgroundColor = '';
        });

        row.addEventListener('click', function() {
          const accountNum = this.dataset.account;
          loadPerformanceData(accountNum);
        });
      });

      // Add click event listeners to buttons (prevent event bubbling)
      document.querySelectorAll('.view-performance-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const accountNum = this.dataset.account;
          loadPerformanceData(accountNum);
        });
      });
    }

    function loadInceptionDate() {
      alert('Please select an account first to load its inception date');
    }

    function loadInceptionDateForAccount(accountNum) {
      const inceptionBtn = document.getElementById('inceptionBtn');
      const originalText = inceptionBtn.textContent;
      inceptionBtn.textContent = 'Loading...';
      inceptionBtn.disabled = true;

      fetch(`get_inception_date.php?acct_num=${accountNum}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.inception_date) {
            document.getElementById('startDate').value = data.inception_date;
          } else {
            throw new Error('No inception date found');
          }
        })
        .catch(error => {
          console.error('Error loading inception date:', error);
          alert('Error loading inception date: ' + error.message);
        })
        .finally(() => {
          inceptionBtn.textContent = originalText;
          inceptionBtn.disabled = false;
        });
    }

    function loadPerformanceData(accountNum) {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      if (!accountNum) {
        showError('Please select an account first');
        return;
      }

      // Clear previous data
      document.querySelector('.tbl-container').style.display = 'none';
      document.getElementById('chart-container').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('loading').style.display = 'block';

      // Scroll to loading indicator
      document.getElementById('loading').scrollIntoView({ behavior: 'smooth' });

      // Build URL with date parameters
      let url = `performance_query.php?acct_num=${accountNum}`;
      if (startDate) {
        url += `&start_date=${startDate}`;
      }
      if (endDate) {
        url += `&end_date=${endDate}`;
      }

      // Fetch data from performance_query.php with selected account and dates
      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          document.getElementById('loading').style.display = 'none';
          
          // Store current account for use in date cell clicks
          window.currentAccount = accountNum;
          window.holdingsAnalysisLoaded = false;

          if (data && data.length > 0) {
            // Create and show chart
            createChart(data);
            document.getElementById('chart-container').style.display = 'block';
            
            // Show holdings analysis container
            document.getElementById('holdings-analysis-container').style.display = 'block';

            // Clear previous header and show table
            document.getElementById('dynamicHeader').innerHTML = '';
            createHeaderColumns(data);
            const container = document.querySelector('.tbl-container');
            container.style.display = 'block';

            // Clear any existing virtual scroll instance
            if (container.__virtualScroll) {
              container.__virtualScroll = null;
            }

            new VirtualScroll(container, data);
          } else {
            showError('No data found for account ' + accountNum);
          }
        })
        .catch(error => {
          document.getElementById('loading').style.display = 'none';
          console.error('Error fetching data:', error);
          showError('Error loading data: ' + error.message);
        });
    }

    function showHoldingsModal(date, accountNum) {
      const modal = document.getElementById('holdingsModal');
      const modalTitle = document.getElementById('modalTitle');
      const holdingsLoading = document.getElementById('holdingsLoading');
      const holdingsError = document.getElementById('holdingsError');
      const holdingsTable = document.getElementById('holdingsTable');

      // Show modal and reset state
      modal.style.display = 'block';
      modalTitle.textContent = `Holdings as of ${date} (Account: ${accountNum})`;
      holdingsLoading.style.display = 'block';
      holdingsError.style.display = 'none';
      holdingsTable.style.display = 'none';

      // Fetch holdings data
      fetch(`scripts/holdings_by_date.php?acct_num=${accountNum}&date=${date}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          holdingsLoading.style.display = 'none';

          if (data && data.length > 0) {
            displayHoldings(data);
            holdingsTable.style.display = 'block';
          } else {
            holdingsError.textContent = 'No holdings found for this date';
            holdingsError.style.display = 'block';
          }
        })
        .catch(error => {
          holdingsLoading.style.display = 'none';
          holdingsError.textContent = 'Error loading holdings: ' + error.message;
          holdingsError.style.display = 'block';
          console.error('Error fetching holdings:', error);
        });
    }

    function displayHoldings(holdings) {
      const tbody = document.getElementById('holdingsTableBody');
      tbody.innerHTML = '';

      holdings.forEach(holding => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #dee2e6';

        const tickerCell = document.createElement('td');
        tickerCell.style.padding = '10px';
        tickerCell.style.border = '1px solid #dee2e6';
        tickerCell.textContent = holding.ticker;

        const sharesCell = document.createElement('td');
        sharesCell.style.padding = '10px';
        sharesCell.style.border = '1px solid #dee2e6';
        sharesCell.style.textAlign = 'right';
        sharesCell.textContent = parseFloat(holding.shares).toLocaleString();

        const priceCell = document.createElement('td');
        priceCell.style.padding = '10px';
        priceCell.style.border = '1px solid #dee2e6';
        priceCell.style.textAlign = 'right';
        priceCell.textContent = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD'
        }).format(parseFloat(holding.price));

        const marketValueCell = document.createElement('td');
        marketValueCell.style.padding = '10px';
        marketValueCell.style.border = '1px solid #dee2e6';
        marketValueCell.style.textAlign = 'right';
        marketValueCell.textContent = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD'
        }).format(parseFloat(holding.market_value));

        row.appendChild(tickerCell);
        row.appendChild(sharesCell);
        row.appendChild(priceCell);
        row.appendChild(marketValueCell);
        tbody.appendChild(row);
      });
    }

    // Modal close functionality
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('holdingsModal');
      const closeBtn = document.querySelector('.close');

      closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });

      window.addEventListener('click', function(event) {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    });

    // Holdings Analysis Functions
    function initializeHoldingsAnalysis() {
      const toggleBtn = document.getElementById('toggleHoldingsAnalysis');
      const content = document.getElementById('holdings-analysis-content');
      
      toggleBtn.addEventListener('click', function() {
        const isVisible = content.style.display !== 'none';
        if (isVisible) {
          content.style.display = 'none';
          toggleBtn.textContent = 'Show Analysis';
        } else {
          content.style.display = 'block';
          toggleBtn.textContent = 'Hide Analysis';
          if (!window.holdingsAnalysisLoaded && window.currentAccount) {
            loadHoldingsAnalysis(window.currentAccount);
          }
        }
      });

      // Add filter and sort event listeners
      document.getElementById('holdingsFilter').addEventListener('input', filterHoldingsTable);
      document.getElementById('holdingsSortBy').addEventListener('change', sortHoldingsTable);
    }

    function loadHoldingsAnalysis(accountNum) {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      document.getElementById('holdings-loading').style.display = 'block';
      document.getElementById('holdings-error').style.display = 'none';
      document.getElementById('holdings-summary').style.display = 'none';
      document.getElementById('holdings-analysis-table').style.display = 'none';

      let url = `scripts/holdings_analysis.php?acct_num=${accountNum}`;
      if (startDate) url += `&start_date=${startDate}`;
      if (endDate) url += `&end_date=${endDate}`;

      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          document.getElementById('holdings-loading').style.display = 'none';
          if (data && data.length > 0) {
            displayHoldingsAnalysis(data);
            window.holdingsAnalysisLoaded = true;
          } else {
            document.getElementById('holdings-error').textContent = 'No holdings analysis data found';
            document.getElementById('holdings-error').style.display = 'block';
          }
        })
        .catch(error => {
          document.getElementById('holdings-loading').style.display = 'none';
          document.getElementById('holdings-error').textContent = 'Error loading holdings analysis: ' + error.message;
          document.getElementById('holdings-error').style.display = 'block';
          console.error('Error loading holdings analysis:', error);
        });
    }

    function displayHoldingsAnalysis(data) {
      window.holdingsAnalysisData = data;
      
      // Display summary metrics
      displayHoldingsSummary(data);
      
      // Display detailed table
      displayHoldingsTable(data);
      
      document.getElementById('holdings-summary').style.display = 'block';
      document.getElementById('holdings-analysis-table').style.display = 'block';
    }

    function displayHoldingsSummary(data) {
      const totalHoldings = data.length;
      const bestPerformer = data.reduce((best, current) => 
        parseFloat(current.total_return_pct) > parseFloat(best.total_return_pct) ? current : best
      );
      const worstPerformer = data.reduce((worst, current) => 
        parseFloat(current.total_return_pct) < parseFloat(worst.total_return_pct) ? current : worst
      );
      const avgDaysHeld = data.reduce((sum, item) => sum + parseFloat(item.days_held_in_period), 0) / data.length;

      document.getElementById('totalHoldings').textContent = totalHoldings;
      document.getElementById('bestPerformer').innerHTML = `${bestPerformer.ticker}<br><span style="font-size: 14px; color: #28a745;">${parseFloat(bestPerformer.total_return_pct).toFixed(1)}%</span>`;
      document.getElementById('worstPerformer').innerHTML = `${worstPerformer.ticker}<br><span style="font-size: 14px; color: #dc3545;">${parseFloat(worstPerformer.total_return_pct).toFixed(1)}%</span>`;
      document.getElementById('avgHoldingPeriod').textContent = Math.round(avgDaysHeld);
    }

    function displayHoldingsTable(data) {
      const tbody = document.getElementById('holdingsAnalysisTableBody');
      tbody.innerHTML = '';

      data.forEach(holding => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #dee2e6';

        const marketValueChangePct = parseFloat(holding.market_value_change_pct) || 0;
        const priceChangePct = parseFloat(holding.price_change_pct) || 0;
        const totalReturnPct = parseFloat(holding.total_return_pct) || 0;
        const totalReturn = parseFloat(holding.total_return) || 0;
        const netCashFlow = parseFloat(holding.net_cash_flow) || 0;

        row.innerHTML = `
          <td style="padding: 8px; border: 1px solid #dee2e6; font-weight: 600;">${holding.ticker}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${holding.first_date}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${holding.last_date}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">${holding.days_held_in_period}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(parseFloat(holding.starting_value))}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(parseFloat(holding.ending_value))}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; color: ${marketValueChangePct >= 0 ? '#28a745' : '#dc3545'};">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(parseFloat(holding.market_value_change))}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; color: ${priceChangePct >= 0 ? '#28a745' : '#dc3545'};">${priceChangePct.toFixed(1)}%</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">${holding.transactions_in_period}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; color: ${netCashFlow >= 0 ? '#28a745' : '#dc3545'};">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(netCashFlow)}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; color: ${totalReturn >= 0 ? '#28a745' : '#dc3545'};">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(totalReturn)}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right; color: ${totalReturnPct >= 0 ? '#28a745' : '#dc3545'};">${totalReturnPct.toFixed(1)}%</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function filterHoldingsTable() {
      const filter = document.getElementById('holdingsFilter').value.toUpperCase();
      const tbody = document.getElementById('holdingsAnalysisTableBody');
      const rows = tbody.getElementsByTagName('tr');

      for (let i = 0; i < rows.length; i++) {
        const ticker = rows[i].getElementsByTagName('td')[0];
        if (ticker) {
          const txtValue = ticker.textContent || ticker.innerText;
          rows[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
        }
      }
    }

    function sortHoldingsTable() {
      const sortBy = document.getElementById('holdingsSortBy').value;
      const sortedData = [...window.holdingsAnalysisData].sort((a, b) => {
        const valueA = parseFloat(a[sortBy]) || 0;
        const valueB = parseFloat(b[sortBy]) || 0;
        return valueB - valueA; // Descending order
      });
      displayHoldingsTable(sortedData);
    }

    // Toggle menu function
    function toggleMenu() {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('show');

      // Close menu when clicking outside of it
      if (sidebar.classList.contains('show')) {
        document.addEventListener('click', closeMenuOutside);
      } else {
        document.removeEventListener('click', closeMenuOutside);
      }
    }

    function closeMenuOutside(event) {
      const sidebar = document.querySelector('.sidebar');
      const menuIcon = document.querySelector('.menu-icon');

      if (!sidebar.contains(event.target) && !menuIcon.contains(event.target)) {
        sidebar.classList.remove('show');
        document.removeEventListener('click', closeMenuOutside);
      }
    }

    // Close menu when clicking on a link
    document.querySelectorAll('.sidebar a').forEach(link => {
      link.addEventListener('click', () => {
        document.querySelector('.sidebar').classList.remove('show');
        document.removeEventListener('click', closeMenuOutside);
      });
    });

    // Set default end date to today
    document.getElementById('endDate').valueAsDate = new Date();
    
    // Initialize holdings analysis
    initializeHoldingsAnalysis();
  </script>
  </div>
</body>
</html>
