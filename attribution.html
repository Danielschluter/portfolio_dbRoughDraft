<!DOCTYPE html>
<html>
<head>
  <title>Performance Query Results</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
  <div class="menu-icon" onclick="toggleMenu()">â˜° Menu</div>

  <div class="sidebar">
    <a href="index.php">Home</a>
    <a href="calcperf.php">Calculate Performance</a>
    <a href="performance.html">Performance Reports</a>
    <a href="performance_results.html">Performance Results</a>
    <a href="holdings.html">Holdings</a>
    <a href="pivot.html">Analysis</a>
    <a href="edgardata.html">Edgar Data</a>
    <a href="risk.html">Risk Metrics</a>
  </div>

  <div class="content">
    <h1>Performance Query Results</h1>

    <div class="accounts-container" style="margin-bottom: 20px;">
      <h2 style="margin-bottom: 15px; color: #333;">Select an Account to View Performance</h2>

      <div class="date-controls" style="margin-bottom: 20px; display: flex; gap: 20px; align-items: center;">
        <div class="control-group">
          <label for="startDate" class="control-label">Start Date:</label>
          <div class="date-input-group">
            <input type="date" id="startDate" class="control-input date-input" value="2023-01-01">
            <button id="inceptionBtn" type="button" class="inception-btn">Use Inception Date</button>
          </div>
        </div>

        <div class="control-group">
          <label for="endDate" class="control-label">End Date:</label>
          <input type="date" id="endDate" class="control-input">
        </div>
      </div>

      <div id="accountsTable" class="accounts-table" style="background: white; border-radius: var(--border-radius); padding: var(--space-4); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
        <div class="loading" style="text-align: center; padding: 20px; color: #666;">Loading accounts...</div>
      </div>
    </div>

  <div id="loading" class="loading" style="display: none;">Loading data...</div>
  <div id="error" class="error" style="display: none;"></div>

  <div id="chart-container" style="display: none; margin-bottom: 20px; background: white; border-radius: var(--border-radius); padding: var(--space-4); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
    <div id="performance-chart" style="width: 100%; height: 400px;"></div>
  </div>

  <div class="tbl-container" style="display: none;">
    <div class="header-row" id="dynamicHeader"></div>
    <div class="virtual-scroll-content"></div>
  </div>

  <!-- Holdings Modal -->
  <div id="holdingsModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
        <h2 id="modalTitle" style="margin: 0; color: #333;">Holdings as of Date</h2>
        <span class="close" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">&times;</span>
      </div>
      <div id="holdingsContent">
        <div id="holdingsLoading" style="text-align: center; padding: 20px; color: #666;">Loading holdings...</div>
        <div id="holdingsError" style="display: none; text-align: center; padding: 20px; color: #d32f2f; background-color: #ffebee; border-radius: 4px;">Error loading holdings</div>
        <div id="holdingsTable" style="display: none;">
          <table style="width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif;">
            <thead>
              <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Ticker</th>
                <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Shares</th>
                <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Price</th>
                <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Market Value</th>
              </tr>
            </thead>
            <tbody id="holdingsTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    class VirtualScroll {
      constructor(container, data) {
        this.container = container;
        container.__virtualScroll = this;
        this.itemHeight = 35;
        this.content = container.querySelector('.virtual-scroll-content');
        this.originalData = data;
        this.data = [...data];
        this.totalItems = data.length;
        this.visibleItems = Math.ceil(container.clientHeight / this.itemHeight);
        this.cachedRows = new Map();
        this.sortColumn = null;
        this.sortAscending = true;

        this.setupScroll();
        this.setupSorting();
        this.render();

        this.container.addEventListener('scroll', () => {
          window.requestAnimationFrame(() => this.render());
        });
      }

      setupSorting() {
        const headers = this.container.querySelectorAll('.header-row > div');
        headers.forEach((header, index) => {
          header.style.cursor = 'pointer';
          header.addEventListener('click', () => this.sort(index));
        });
      }

      sort(columnIndex) {
        const headers = Array.from(this.container.querySelectorAll('.header-row > div'));
        const columnKey = headers[columnIndex].textContent;

        if (this.sortColumn === columnKey) {
          this.sortAscending = !this.sortAscending;
        } else {
          this.sortColumn = columnKey;
          this.sortAscending = true;
        }

        this.data.sort((a, b) => {
          const valueA = a[columnKey];
          const valueB = b[columnKey];

          if (!isNaN(valueA) && !isNaN(valueB)) {
            return this.sortAscending ? valueA - valueB : valueB - valueA;
          }

          const comparison = String(valueA).localeCompare(String(valueB));
          return this.sortAscending ? comparison : -comparison;
        });

        this.cachedRows.clear();
        this.render();
      }

      createRow(rowData, index) {
        if (this.cachedRows.has(index)) {
          return this.cachedRows.get(index);
        }

        const row = document.createElement('div');
        row.className = 'div-row';

        let cellIndex = 0;
        for (let x in rowData) {
          const cell = document.createElement('div');
          let cellValue = rowData[x];

          // Make date cells clickable
          if (x === 'date') {
            cell.style.cursor = 'pointer';
            cell.style.color = '#007bff';
            cell.style.textDecoration = 'underline';
            cell.addEventListener('click', () => {
              // Get account number from the currently loaded data context
              const currentAccount = window.currentAccount || 'Unknown';
              showHoldingsModal(cellValue, currentAccount);
            });
          }

          // Format numeric values
          if (!isNaN(cellValue) && cellValue !== null && cellValue !== '') {
            const num = parseFloat(cellValue);
            //console.log(x);
            if (x == 'pct_return') {
              cellValue = (num * 100).toFixed(2) + '%';
            } else {
              cellValue = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
              }).format(num);
            }

          }

          cell.textContent = cellValue;
          row.appendChild(cell);
          cellIndex++;
        }

        this.cachedRows.set(index, row);
        return row;
      }

      setupScroll() {
        this.content.style.height = `${this.totalItems * this.itemHeight}px`;
      }

      render() {
        const scrollTop = this.container.scrollTop;
        const startIndex = Math.floor(scrollTop / this.itemHeight);
        const endIndex = Math.min(startIndex + this.visibleItems + 2, this.totalItems);

        this.content.innerHTML = '';

        for(let i = startIndex; i < endIndex; i++) {
          if (i >= 0 && i < this.data.length) {
            const row = this.createRow(this.data[i], i);
            row.style.position = 'absolute';
            row.style.top = `${i * this.itemHeight}px`;
            row.style.width = '100%';
            this.content.appendChild(row);
          }
        }
      }
    }

    function createHeaderColumns(data) {
      if (!data || data.length === 0) return;

      const headerRow = document.getElementById('dynamicHeader');
      const firstRow = data[0];

      Object.keys(firstRow).forEach(key => {
        const headerDiv = document.createElement('div');
        headerDiv.textContent = key;
        headerRow.appendChild(headerDiv);
      });
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').textContent = message;
      document.getElementById('error').style.display = 'block';
    }

    function createChart(data) {
      const dates = data.map(row => row.date);

      // Calculate growth of $10,000 based on percentage returns
      let portfolioValues = [];
      let spyValues = [];
      let portfolioValue = 10000;
      let spyValue = 10000;
      let portfolioReturns = [];
      let spyReturns = [];

      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        const portfolioReturn = parseFloat(row.pct_return) || 0;
        const spyReturn = parseFloat(row.spy_pct_return) || 0;

        portfolioReturns.push(portfolioReturn);
        spyReturns.push(spyReturn);

        // Calculate new values based on previous value and return
        portfolioValue = portfolioValue * (1 + portfolioReturn);
        spyValue = spyValue * (1 + spyReturn);

        portfolioValues.push(portfolioValue);
        spyValues.push(spyValue);
      }

      // Calculate metrics
      const metrics = calculateMetrics(portfolioValues, spyValues, portfolioReturns, spyReturns);
      displayMetrics(metrics);

      const options = {
        series: [{
          name: 'Portfolio ($10,000 Growth)',
          data: portfolioValues
        }, {
          name: 'SPY ($10,000 Growth)',
          data: spyValues
        }],
        chart: {
          type: 'line',
          height: 400,
          zoom: {
            enabled: true
          }
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          curve: 'smooth',
          width: 2
        },
        title: {
          text: 'Growth of $10,000 - Portfolio vs SPY',
          align: 'center'
        },
        xaxis: {
          categories: dates,
          type: 'datetime',
          labels: {
            rotate: -45,
            style: {
              fontSize: '12px'
            }
          }
        },
        yaxis: {
          labels: {
            formatter: function(val) {
              return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
              }).format(val);
            }
          }
        },
        colors: ['#008FFB', '#00E396'],
        legend: {
          position: 'top',
          horizontalAlign: 'right',
          floating: true,
          offsetY: -25,
          offsetX: -5
        },
        tooltip: {
          x: {
            format: 'MMM dd, yyyy'
          },
          y: {
            formatter: function(value) {
              return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
              }).format(value);
            }
          }
        }
      };

      const chart = new ApexCharts(document.querySelector("#performance-chart"), options);
      chart.render();
    }

    function calculateMetrics(portfolioValues, spyValues, portfolioReturns, spyReturns) {
      // Calculate CAGR
      const portfolioFirstVal = portfolioValues[0];
      const portfolioLastVal = portfolioValues[portfolioValues.length - 1];
      const spyFirstVal = spyValues[0];
      const spyLastVal = spyValues[spyValues.length - 1];
      const years = portfolioValues.length / 252; // Assuming daily data, 252 trading days per year

      const portfolioCagr = (Math.pow(portfolioLastVal / portfolioFirstVal, 1 / years) - 1) * 100;
      const spyCagr = (Math.pow(spyLastVal / spyFirstVal, 1 / years) - 1) * 100;

      // Calculate standard deviation (annualized)
      const portfolioStdDev = calculateStandardDeviation(portfolioReturns) * Math.sqrt(252) * 100;
      const spyStdDev = calculateStandardDeviation(spyReturns) * Math.sqrt(252) * 100;

      // Calculate Sharpe ratio (assuming 0% risk-free rate)
      const portfolioSharpe = portfolioCagr / portfolioStdDev;
      const spySharpe = spyCagr / spyStdDev;

      return {
        portfolio: {
          cagr: portfolioCagr,
          stdDev: portfolioStdDev,
          sharpe: portfolioSharpe,
          finalValue: portfolioLastVal
        },
        spy: {
          cagr: spyCagr,
          stdDev: spyStdDev,
          sharpe: spySharpe,
          finalValue: spyLastVal
        }
      };
    }

    function calculateStandardDeviation(returns) {
      const mean = returns.reduce((sum, ret) => sum + ret, 0) / returns.length;
      const variance = returns.reduce((sum, ret) => sum + Math.pow(ret - mean, 2), 0) / returns.length;
      return Math.sqrt(variance);
    }

    function displayMetrics(metrics) {
      const metricsHtml = `
        <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">Performance Metrics</h3>
          <table style="width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif;">
            <thead>
              <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Metric</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600; color: #008FFB;">Portfolio</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600; color: #00E396;">SPY Benchmark</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600; color: #856404;">Difference</th>
              </tr>
            </thead>
            <tbody>
              <tr style="background-color: #fff;">
                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 500;">CAGR</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.portfolio.cagr.toFixed(2)}%</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.spy.cagr.toFixed(2)}%</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${(metrics.portfolio.cagr - metrics.spy.cagr) > 0 ? '#28a745' : '#dc3545'};">${(metrics.portfolio.cagr - metrics.spy.cagr) > 0 ? '+' : ''}${(metrics.portfolio.cagr - metrics.spy.cagr).toFixed(2)}%</td>
              </tr>
              <tr style="background-color: #f8f9fa;">
                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 500;">Volatility</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.portfolio.stdDev.toFixed(2)}%</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.spy.stdDev.toFixed(2)}%</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${(metrics.portfolio.stdDev - metrics.spy.stdDev) > 0 ? '+' : ''}${(metrics.portfolio.stdDev - metrics.spy.stdDev).toFixed(2)}%</td>
              </tr>
              <tr style="background-color: #fff;">
                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 500;">Sharpe Ratio</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.portfolio.sharpe.toFixed(2)}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${metrics.spy.sharpe.toFixed(2)}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${(metrics.portfolio.sharpe - metrics.spy.sharpe) > 0 ? '#28a745' : '#dc3545'};">${(metrics.portfolio.sharpe - metrics.spy.sharpe) > 0 ? '+' : ''}${(metrics.portfolio.sharpe - metrics.spy.sharpe).toFixed(2)}</td>
              </tr>
              <tr style="background-color: #f8f9fa;">
                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 500;">Final Value</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(metrics.portfolio.finalValue)}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(metrics.spy.finalValue)}</td>
                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${(metrics.portfolio.finalValue - metrics.spy.finalValue) > 0 ? '#28a745' : '#dc3545'};">${new Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(metrics.portfolio.finalValue - metrics.spy.finalValue)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;

      let metricsDiv = document.getElementById('metrics-container');
      if (!metricsDiv) {
        metricsDiv = document.createElement('div');
        metricsDiv.id = 'metrics-container';
        // Insert metrics after chart but before data table
        const dataTable = document.querySelector('.tbl-container');
        dataTable.parentNode.insertBefore(metricsDiv, dataTable);
      }
      metricsDiv.innerHTML = metricsHtml;
    }

    // Load accounts on page load
    loadAccounts();

    // Add event listener for inception date button
    document.getElementById('inceptionBtn').addEventListener('click', loadInceptionDate);

    function loadAccounts() {
      fetch('scripts/loadaccounts.php')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(accounts => {
          displayAccountsTable(accounts);
        })
        .catch(error => {
          console.error('Error loading accounts:', error);
          document.getElementById('accountsTable').innerHTML = '<div class="error" style="text-align: center; padding: 20px; color: #d32f2f;">Error loading accounts</div>';
        });
    }

    function displayAccountsTable(accounts) {
      const container = document.getElementById('accountsTable');

      if (!accounts || accounts.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No accounts found</div>';
        return;
      }

      // Create table HTML
      let tableHtml = `
        <table style="width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif;">
          <thead>
            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
              <th style="padding: 15px; text-align: left; border: 1px solid #dee2e6; font-weight: 600; font-size: 16px;">Account Number</th>
              <th style="padding: 15px; text-align: center; border: 1px solid #dee2e6; font-weight: 600; font-size: 16px;">Action</th>
            </tr>
          </thead>
          <tbody>
      `;

      accounts.forEach(account => {
        tableHtml += `
          <tr class="account-row" data-account="${account.acct_num}" style="cursor: pointer; transition: background-color 0.2s;">
            <td style="padding: 15px; border: 1px solid #dee2e6; font-size: 16px; font-weight: 500;">${account.acct_num}</td>
            <td style="padding: 15px; border: 1px solid #dee2e6; text-align: center;">
              <button class="view-performance-btn" data-account="${account.acct_num}" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
                View Performance
              </button>
            </td>
          </tr>
        `;
      });

      tableHtml += `
          </tbody>
        </table>
      `;

      container.innerHTML = tableHtml;

      // Add click event listeners to rows and buttons
      document.querySelectorAll('.account-row').forEach(row => {
        row.addEventListener('mouseenter', function() {
          this.style.backgroundColor = '#f8f9fa';
        });

        row.addEventListener('mouseleave', function() {
          this.style.backgroundColor = '';
        });

        row.addEventListener('click', function() {
          const accountNum = this.dataset.account;
          loadPerformanceData(accountNum);
        });
      });

      // Add click event listeners to buttons (prevent event bubbling)
      document.querySelectorAll('.view-performance-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const accountNum = this.dataset.account;
          loadPerformanceData(accountNum);
        });
      });
    }

    function loadInceptionDate() {
      alert('Please select an account first to load its inception date');
    }

    function loadInceptionDateForAccount(accountNum) {
      const inceptionBtn = document.getElementById('inceptionBtn');
      const originalText = inceptionBtn.textContent;
      inceptionBtn.textContent = 'Loading...';
      inceptionBtn.disabled = true;

      fetch(`get_inception_date.php?acct_num=${accountNum}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.inception_date) {
            document.getElementById('startDate').value = data.inception_date;
          } else {
            throw new Error('No inception date found');
          }
        })
        .catch(error => {
          console.error('Error loading inception date:', error);
          alert('Error loading inception date: ' + error.message);
        })
        .finally(() => {
          inceptionBtn.textContent = originalText;
          inceptionBtn.disabled = false;
        });
    }

    function loadPerformanceData(accountNum) {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!accountNum) {
            showError('Please select an account first');
            return;
        }

        // Clear previous data
        document.querySelector('.tbl-container').style.display = 'none';
        document.getElementById('chart-container').style.display = 'none';
        document.getElementById('error').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        // Hide attribution container if it exists
        const attributionContainer = document.getElementById('attributionContainer');
        if (attributionContainer) {
            attributionContainer.style.display = 'none';
        }

        // Scroll to loading indicator
        document.getElementById('loading').scrollIntoView({ behavior: 'smooth' });

        // Build URL with date parameters
        let url = `performance_query.php?acct_num=${accountNum}`;
        if (startDate) {
            url += `&start_date=${startDate}`;
        }
        if (endDate) {
            url += `&end_date=${endDate}`;
        }

        // Fetch performance data and attribution analysis in parallel
        Promise.all([
            fetch(url).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            }),
            // Load attribution analysis
            loadAttributionAnalysis(accountNum, startDate, endDate)
        ])
        .then(([performanceData, attributionData]) => {
            document.getElementById('loading').style.display = 'none';

            // Store current account for use in date cell clicks
            window.currentAccount = accountNum;

            if (performanceData && performanceData.length > 0) {
                // Create and show chart
                createChart(performanceData);
                document.getElementById('chart-container').style.display = 'block';

                // Clear previous header and show table
                document.getElementById('dynamicHeader').innerHTML = '';
                createHeaderColumns(performanceData);
                const container = document.querySelector('.tbl-container');
                container.style.display = 'block';

                // Clear any existing virtual scroll instance
                if (container.__virtualScroll) {
                    container.__virtualScroll = null;
                }

                new VirtualScroll(container, performanceData);

                // Show attribution analysis if data is available
                if (attributionData) {
                    displaySecurityAttributionAnalysis(attributionData, accountNum, startDate, endDate);
                }
            } else {
                showError('No data found for account ' + accountNum);
            }
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            console.error('Error fetching data:', error);
            showError('Error loading data: ' + error.message);
        });
    }


    // Attribution analysis loader
    async function loadAttributionAnalysis(accountNum, startDate, endDate, benchmark = 'SPY') {
        try {
            const params = new URLSearchParams({
                acct_num: accountNum,
                type: 'summary',
                benchmark: benchmark
            });

            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            const response = await fetch(`attribution_analysis.php?${params}`);

            if (!response.ok) {
                console.warn('Attribution analysis not available:', response.status);
                return null;
            }

            return await response.json();
        } catch (error) {
            console.warn('Attribution analysis failed:', error);
            return null;
        }
    }

    // Display security-level attribution analysis results
    function displaySecurityAttributionAnalysis(attributionData, accountNum, startDate, endDate) {
        // Create or get attribution container
        let container = document.getElementById('attributionContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'attributionContainer';
            container.className = 'attribution-analysis-container';

            // Insert after metrics container
            const metricsContainer = document.getElementById('metrics-container');
            if (metricsContainer) {
                metricsContainer.parentNode.insertBefore(container, metricsContainer.nextSibling);
            } else {
                // Insert before data table
                const dataTable = document.querySelector('.tbl-container');
                dataTable.parentNode.insertBefore(container, dataTable);
            }
        }

        const summary = attributionData.summary;
        const securityData = attributionData.security_attribution; // Changed from sector_attribution

        container.innerHTML = `
            <div class="attribution-header">
                <h2>Portfolio Attribution Analysis</h2>
                <div class="attribution-period">
                    Account: ${accountNum} | ${startDate || 'Inception'} to ${endDate || 'Latest'}
                    <span class="benchmark-label">vs SPY</span>
                </div>
            </div>

            <div class="attribution-summary-grid">
                <div class="summary-card allocation-card">
                    <div class="card-header">
                        <h4>Asset Allocation Effect</h4>
                        <span class="info-tooltip" title="Performance impact from sector weightings vs benchmark">â“˜</span>
                    </div>
                    <div class="card-value ${summary.total_allocation_effect >= 0 ? 'positive' : 'negative'}">
                        ${summary.total_allocation_effect > 0 ? '+' : ''}${summary.total_allocation_effect} bps
                    </div>
                    <div class="card-subtitle">
                        Hit Rate: ${summary.allocation_hit_rate}%
                    </div>
                </div>

                <div class="summary-card selection-card">
                    <div class="card-header">
                        <h4>Security Selection Effect</h4>
                        <span class="info-tooltip" title="Performance impact from individual security picks">â“˜</span>
                    </div>
                    <div class="card-value ${summary.total_selection_effect >= 0 ? 'positive' : 'negative'}">
                        ${summary.total_selection_effect > 0 ? '+' : ''}${summary.total_selection_effect} bps
                    </div>
                    <div class="card-subtitle">
                        Hit Rate: ${summary.selection_hit_rate}%
                    </div>
                </div>

                <div class="summary-card total-card">
                    <div class="card-header">
                        <h4>Total Active Return</h4>
                        <span class="info-tooltip" title="Total excess return vs benchmark">â“˜</span>
                    </div>
                    <div class="card-value ${summary.total_active_return >= 0 ? 'positive' : 'negative'}">
                        ${summary.total_active_return > 0 ? '+' : ''}${summary.total_active_return} bps
                    </div>
                    <div class="card-subtitle">
                        ${summary.primary_driver} Driven Strategy
                    </div>
                </div>

                <div class="summary-card insight-card">
                    <div class="card-header">
                        <h4>Key Insight</h4>
                    </div>
                    <div class="card-insight">
                        ${generateAttributionInsight(summary, securityData)}
                    </div>
                </div>
            </div>

            <div class="attribution-details">
                <div class="detail-tabs">
                    <button class="tab-btn active" onclick="showAttributionTab('security')">Security Breakdown</button> <!-- Changed to Security Breakdown -->
                    <button class="tab-btn" onclick="showAttributionTab('chart')">Visualization</button>
                </div>

                <div id="securityTab" class="tab-content active"> <!-- Changed id to securityTab -->
                    ${renderSecurityAttributionTable(securityData)} <!-- Changed to renderSecurityAttributionTable -->
                </div>

                <div id="chartTab" class="tab-content" style="display: none;">
                    <div class="chart-container">
                        <canvas id="attributionChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>
        `;

        container.style.display = 'block';

        // Create the attribution chart (initially hidden)
        setTimeout(() => createAttributionChart(securityData), 100); // Changed to securityData
    }

    // Generate insight text based on attribution results
    function generateAttributionInsight(summary, securityData) { // Changed parameter name
        const totalActive = summary.total_active_return;
        const primaryDriver = summary.primary_driver;
        // Find the top contributing security
        const topSecurity = securityData.reduce((max, security) => 
            Math.abs(security.total_effect) > Math.abs(max.total_effect) ? security : max
        );

        if (totalActive > 50) {
            return `Strong outperformance of +${totalActive} bps, primarily driven by ${primaryDriver.toLowerCase()}. ${topSecurity.security_name} (Security) contributed ${topSecurity.total_effect > 0 ? '+' : ''}${topSecurity.total_effect} bps.`;
        } else if (totalActive > 0) {
            return `Modest outperformance of +${totalActive} bps through ${primaryDriver.toLowerCase()}. Performance was balanced across securities.`;
        } else if (totalActive > -50) {
            return `Slight underperformance of ${totalActive} bps. ${topSecurity.security_name} (Security) was the main detractor at ${topSecurity.total_effect} bps.`;
        } else {
            return `Significant underperformance of ${totalActive} bps. ${primaryDriver} decisions negatively impacted returns, particularly with ${topSecurity.security_name} (Security).`;
        }
    }

    // Render security attribution table
    function renderSecurityAttributionTable(securityData) { // Changed function name
        const tableRows = securityData.map(security => ` // Changed variable name
            <tr>
                <td class="sector-name">${security.security_name}</td> <!-- Changed from sector to security_name -->
                <td class="number-cell">${security.portfolio_weight}%</td>
                <td class="number-cell">${security.benchmark_weight}%</td>
                <td class="number-cell">${security.portfolio_return}%</td>
                <td class="number-cell">${security.benchmark_return}%</td>
                <td class="number-cell ${security.allocation_effect >= 0 ? 'positive' : 'negative'}">
                    ${security.allocation_effect > 0 ? '+' : ''}${security.allocation_effect}
                </td>
                <td class="number-cell ${security.selection_effect >= 0 ? 'positive' : 'negative'}">
                    ${security.selection_effect > 0 ? '+' : ''}${security.selection_effect}
                </td>
                <td class="number-cell ${security.total_effect >= 0 ? 'positive' : 'negative'}">
                    <strong>${security.total_effect > 0 ? '+' : ''}${security.total_effect}</strong>
                </td>
            </tr>
        `).join('');

        return `
            <table class="attribution-table">
                <thead>
                    <tr>
                        <th>Security Name</th> <!-- Changed from Sector -->
                        <th>Portfolio Weight</th>
                        <th>Benchmark Weight</th>
                        <th>Portfolio Return</th>
                        <th>Benchmark Return</th>
                        <th>Allocation Effect (bps)</th>
                        <th>Selection Effect (bps)</th>
                        <th>Total Effect (bps)</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        `;
    }

    // Create attribution waterfall chart
    function createAttributionChart(securityData) { // Changed parameter name
        const canvas = document.getElementById('attributionChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        // Prepare data for stacked bar chart
        const labels = securityData.map(s => s.security_name); // Changed from security_name
        const allocationData = securityData.map(s => s.allocation_effect);
        const selectionData = securityData.map(s => s.selection_effect);
        const interactionData = securityData.map(s => s.interaction_effect); // Assuming interaction_effect exists

        if (window.attributionChart) {
            window.attributionChart.destroy();
        }

        window.attributionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Allocation Effect',
                        data: allocationData,
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    },
                    {
                        label: 'Selection Effect',
                        data: selectionData,
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1
                    },
                    {
                        label: 'Interaction Effect',
                        data: interactionData,
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Attribution (basis points)'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                const dataIndex = context[0].dataIndex;
                                const security = securityData[dataIndex]; // Changed variable name
                                return [
                                    `Portfolio Weight: ${security.portfolio_weight}%`,
                                    `Benchmark Weight: ${security.benchmark_weight}%`,
                                    `Weight Difference: ${(security.portfolio_weight - security.benchmark_weight).toFixed(1)}%`,
                                    `Return Difference: ${(security.portfolio_return - security.benchmark_return).toFixed(2)}%`
                                ];
                            }
                        }
                    }
                }
            }
        });
    }

    // Tab switching functionality
    function showAttributionTab(tabName) {
        // Remove active class from all tabs and content
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

        // Add active class to clicked tab
        event.target.classList.add('active');

        // Show corresponding content
        const contentId = tabName + 'Tab';
        const content = document.getElementById(contentId);
        if (content) {
            content.style.display = 'block';
        }

        // If showing chart tab, ensure chart is properly sized
        if (tabName === 'chart' && window.attributionChart) {
            setTimeout(() => window.attributionChart.resize(), 100);
        }
    }

    // Add attribution-specific CSS styles
    const attributionCSS = `
        .attribution-analysis-container {
            margin: 24px 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            border: 1px solid #e5e7eb;
        }

        .attribution-header {
            text-align: center;
            margin-bottom: 24px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 16px;
        }

        .attribution-header h2 {
            color: #1f2937;
            margin: 0 0 8px 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .attribution-period {
            color: #6b7280;
            font-size: 14px;
        }

        .benchmark-label {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 500;
        }

        .attribution-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .card-header h4 {
            margin: 0;
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-tooltip {
            cursor: help;
            color: #9ca3af;
            font-size: 16px;
        }

        .card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .card-value.positive {
            color: #10b981;
        }

        .card-value.negative {
            color: #ef4444;
        }

        .card-subtitle {
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
        }

        .insight-card .card-insight {
            font-size: 14px;
            line-height: 1.5;
            color: #4b5563;
            text-align: left;
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
        }

        .attribution-details {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
        }

        .detail-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #3b82f6;
        }

        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            background: white;
            border-radius: 8px;
            padding: 16px;
        }

        .attribution-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: white;
        }

        .attribution-table th,
        .attribution-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .attribution-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .attribution-table tbody tr:hover {
            background: #f8fafc;
        }

        .sector-name { /* Keep for potential fallback, though ideally only security_name is used */
            font-weight: 600;
            color: #1f2937;
        }

        .number-cell {
            text-align: right;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }

        .positive {
            color: #059669;
            font-weight: 600;
        }

        .negative {
            color: #dc2626;
            font-weight: 600;
        }

        .chart-container {
            height: 400px;
            position: relative;
            background: white;
            border-radius: 8px;
            padding: 16px;
        }

        @media (max-width: 768px) {
            .attribution-summary-grid {
                grid-template-columns: 1fr;
            }

            .attribution-analysis-container {
                padding: 16px;
                margin: 10px;
            }

            .detail-tabs {
                flex-direction: column;
            }

            .tab-btn {
                text-align: left;
                border-bottom: none;
                border-left: 3px solid transparent;
            }

            .tab-btn.active {
                border-bottom: none;
                border-left-color: #3b82f6;
                background: #f8fafc;
            }
        }
    `;

    // Add the CSS to the page if it doesn't exist
    if (!document.getElementById('attribution-styles')) {
        const style = document.createElement('style');
        style.id = 'attribution-styles';
        style.textContent = attributionCSS;
        document.head.appendChild(style);
    }

    // Export functions for use in other parts of the application
    window.AttributionAnalysis = {
        loadAttributionAnalysis,
        displaySecurityAttributionAnalysis, // Changed to security version
        showAttributionTab,
        createAttributionChart
    };



    function showHoldingsModal(date, accountNum) {
      const modal = document.getElementById('holdingsModal');
      const modalTitle = document.getElementById('modalTitle');
      const holdingsLoading = document.getElementById('holdingsLoading');
      const holdingsError = document.getElementById('holdingsError');
      const holdingsTable = document.getElementById('holdingsTable');

      // Show modal and reset state
      modal.style.display = 'block';
      modalTitle.textContent = `Holdings as of ${date} (Account: ${accountNum})`;
      holdingsLoading.style.display = 'block';
      holdingsError.style.display = 'none';
      holdingsTable.style.display = 'none';

      // Fetch holdings data
      fetch(`scripts/holdings_by_date.php?acct_num=${accountNum}&date=${date}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          holdingsLoading.style.display = 'none';

          if (data && data.length > 0) {
            displayHoldings(data);
            holdingsTable.style.display = 'block';
          } else {
            holdingsError.textContent = 'No holdings found for this date';
            holdingsError.style.display = 'block';
          }
        })
        .catch(error => {
          holdingsLoading.style.display = 'none';
          holdingsError.textContent = 'Error loading holdings: ' + error.message;
          holdingsError.style.display = 'block';
          console.error('Error fetching holdings:', error);
        });
    }

    function displayHoldings(holdings) {
      const tbody = document.getElementById('holdingsTableBody');
      tbody.innerHTML = '';

      holdings.forEach(holding => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #dee2e6';

        const tickerCell = document.createElement('td');
        tickerCell.style.padding = '10px';
        tickerCell.style.border = '1px solid #dee2e6';
        tickerCell.textContent = holding.ticker;

        const sharesCell = document.createElement('td');
        sharesCell.style.padding = '10px';
        sharesCell.style.border = '1px solid #dee2e6';
        sharesCell.style.textAlign = 'right';
        sharesCell.textContent = parseFloat(holding.shares).toLocaleString();

        const priceCell = document.createElement('td');
        priceCell.style.padding = '10px';
        priceCell.style.border = '1px solid #dee2e6';
        priceCell.style.textAlign = 'right';
        priceCell.textContent = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD'
        }).format(parseFloat(holding.price));

        const marketValueCell = document.createElement('td');
        marketValueCell.style.padding = '10px';
        marketValueCell.style.border = '1px solid #dee2e6';
        marketValueCell.style.textAlign = 'right';
        marketValueCell.textContent = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD'
        }).format(parseFloat(holding.market_value));

        row.appendChild(tickerCell);
        row.appendChild(sharesCell);
        row.appendChild(priceCell);
        row.appendChild(marketValueCell);
        tbody.appendChild(row);
      });
    }

    // Modal close functionality
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('holdingsModal');
      const closeBtn = document.querySelector('.close');

      closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });

      window.addEventListener('click', function(event) {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    });

    // Toggle menu function
    function toggleMenu() {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('show');

      // Close menu when clicking outside of it
      if (sidebar.classList.contains('show')) {
        document.addEventListener('click', closeMenuOutside);
      } else {
        document.removeEventListener('click', closeMenuOutside);
      }
    }

    function closeMenuOutside(event) {
      const sidebar = document.querySelector('.sidebar');
      const menuIcon = document.querySelector('.menu-icon');

      if (!sidebar.contains(event.target) && !menuIcon.contains(event.target)) {
        sidebar.classList.remove('show');
        document.removeEventListener('click', closeMenuOutside);
      }
    }

    // Close menu when clicking on a link
    document.querySelectorAll('.sidebar a').forEach(link => {
      link.addEventListener('click', () => {
        document.querySelector('.sidebar').classList.remove('show');
        document.removeEventListener('click', closeMenuOutside);
      });
    });

    // Set default end date to today
    document.getElementById('endDate').valueAsDate = new Date();
  </script>
  </div>
</body>
</html>