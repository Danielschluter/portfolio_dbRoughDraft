
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Asset Performance Dashboard</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #eff6ff;
            --secondary: #10b981;
            --accent: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin: 0 0 var(--space-3) 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dashboard-subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        .controls-card {
            background: white;
            border-radius: var(--border-radius);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            margin-bottom: var(--space-6);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .form-input {
            padding: var(--space-3);
            border: 2px solid var(--gray-200);
            border-radius: calc(var(--border-radius) / 2);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: white;
            color: var(--gray-700);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            color: white;
            border: none;
            padding: var(--space-3) var(--space-6);
            border-radius: calc(var(--border-radius) / 2);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            justify-content: center;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, var(--primary-hover) 0%, #1e40af 100%);
        }

        .btn-primary:active {
            transform: translateY(-1px);
        }

        .results-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .results-header {
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            padding: var(--space-5);
            border-bottom: 1px solid var(--gray-200);
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin: 0;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
        }

        .performance-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .performance-table th {
            background: var(--gray-50);
            padding: var(--space-4);
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            font-size: 0.75rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .performance-table td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
            font-family: 'Inter', monospace;
        }

        .performance-table tr:hover {
            background-color: var(--gray-50);
        }

        .performance-table tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .performance-table tr:nth-child(even):hover {
            background-color: var(--gray-50);
        }

        .text-right {
            text-align: right;
        }

        .text-green {
            color: var(--secondary);
            font-weight: 600;
        }

        .text-red {
            color: #ef4444;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: var(--space-8);
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--space-4);
        }

        .loading-state {
            text-align: center;
            padding: var(--space-8);
            color: var(--gray-600);
        }

        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--gray-200);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-right: var(--space-2);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .main-container {
                padding: var(--space-4);
            }

            .dashboard-title {
                font-size: 2rem;
            }

            .controls-grid {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }

            .controls-card {
                padding: var(--space-4);
            }

            .performance-table {
                font-size: 0.8rem;
            }

            .performance-table th,
            .performance-table td {
                padding: var(--space-2) var(--space-3);
            }
        }

        @media (max-width: 480px) {
            .dashboard-title {
                font-size: 1.75rem;
            }

            .performance-table th,
            .performance-table td {
                padding: var(--space-2);
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">üìä Asset Performance Dashboard</h1>
            <p class="dashboard-subtitle">Analyze portfolio performance with detailed asset-level insights</p>
        </div>

        <div class="controls-card">
            <div class="controls-grid">
                <div class="form-group">
                    <label class="form-label" for="startDate">Start Date</label>
                    <input type="date" id="startDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="endDate">End Date</label>
                    <input type="date" id="endDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="accountNumber">Account Number</label>
                    <select id="accountNumber" class="form-input" required>
                        <option value="">Loading accounts...</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn-primary" onclick="fetchPerformanceData()">
                        <span>üîç</span>
                        Analyze Performance
                    </button>
                </div>
            </div>
        </div>

        <div id="results-container"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Set default dates to a reasonable range
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setMonth(today.getMonth() - 1);

            document.getElementById('endDate').valueAsDate = today;
            document.getElementById('startDate').valueAsDate = lastMonth;

            // Load accounts on page load
            loadAccounts();
        });

        async function loadAccounts() {
            try {
                const response = await fetch('scripts/loadaccounts.php');
                const accounts = await response.json();
                const selectElement = document.getElementById('accountNumber');
                selectElement.innerHTML = '<option value="">Select an account...</option>';
                
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.acct_num;
                    option.textContent = account.acct_num;
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading accounts:', error);
                const selectElement = document.getElementById('accountNumber');
                selectElement.innerHTML = '<option value="">Error loading accounts</option>';
            }
        }

        async function fetchPerformanceData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const resultsContainer = document.getElementById('results-container');

            if (!startDate || !endDate || !accountNumber) {
                resultsContainer.innerHTML = `
                    <div class="results-container">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <h3>Missing Information</h3>
                            <p>Please select a start date, end date, and account number to continue.</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Show loading state
            resultsContainer.innerHTML = `
                <div class="results-container">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        Loading performance data...
                    </div>
                </div>
            `;

            try {
                const url = `byasset.php?beg=${startDate}&end=${endDate}&q=${accountNumber}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="results-container">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <h3>No Data Found</h3>
                                <p>No performance data available for the selected period and account.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                // Build the enhanced table
                let tableHTML = `
                    <div class="results-container">
                        <div class="results-header">
                            <h2 class="results-title">Performance Results</h2>
                            <p style="margin: 0.5rem 0 0 0; color: var(--gray-600); font-size: 0.875rem;">
                                Account ${accountNumber} ‚Ä¢ ${formatDate(startDate)} to ${formatDate(endDate)} ‚Ä¢ ${data.length} records
                            </p>
                        </div>
                        <div class="table-container">
                            <table class="performance-table">
                                <thead>
                                    <tr>
                `;

                const headers = Object.keys(data[0]);
                headers.forEach(header => {
                    const displayName = header.replace(/_/g, ' ').toUpperCase();
                    const alignment = ['ticker'].includes(header) ? '' : 'text-right';
                    tableHTML += `<th class="${alignment}">${displayName}</th>`;
                });

                tableHTML += '</tr></thead><tbody>';

                data.forEach(row => {
                    tableHTML += '<tr>';
                    headers.forEach(header => {
                        let cellValue = row[header];
                        let cellClass = '';
                        
                        if (header === 'contribution_to_return_pct') {
                            const value = parseFloat(cellValue);
                            cellValue = `${value.toFixed(2)}%`;
                            cellClass = `text-right ${value >= 0 ? 'text-green' : 'text-red'}`;
                        } else if (header === 'ticker') {
                            cellClass = '';
                        } else if (typeof cellValue === 'number' || !isNaN(parseFloat(cellValue))) {
                            cellValue = new Intl.NumberFormat('en-US', { 
                                style: 'currency', 
                                currency: 'USD' 
                            }).format(cellValue);
                            cellClass = 'text-right';
                        } else {
                            cellClass = header === 'ticker' ? '' : 'text-right';
                        }
                        
                        tableHTML += `<td class="${cellClass}">${cellValue}</td>`;
                    });
                    tableHTML += '</tr>';
                });

                tableHTML += '</tbody></table></div></div>';
                resultsContainer.innerHTML = tableHTML;

            } catch (error) {
                console.error('Error fetching performance data:', error);
                resultsContainer.innerHTML = `
                    <div class="results-container">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ùå</div>
                            <h3>Error Loading Data</h3>
                            <p>An error occurred while fetching performance data. Please try again.</p>
                        </div>
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Fixed the stockData reference issue
        const stockData = [
            {
                date: "2024-09-30",
                ticker: "SNOW",
                shares: 0,
                close: 114.86,
                totalshares: 15,
                marketvalue: 1722.90,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-01",
                ticker: "SNOW",
                shares: 0,
                close: 110.23,
                totalshares: 15,
                marketvalue: 1653.45,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-02",
                ticker: "SNOW",
                shares: 0,
                close: 109.65,
                totalshares: 15,
                marketvalue: 1644.75,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-03",
                ticker: "SNOW",
                shares: 0,
                close: 110.47,
                totalshares: 15,
                marketvalue: 1657.05,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-04",
                ticker: "SNOW",
                shares: 0,
                close: 114.72,
                totalshares: 15,
                marketvalue: 1720.80,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-07",
                ticker: "SNOW",
                shares: 0,
                close: 113.82,
                totalshares: 15,
                marketvalue: 1707.30,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-08",
                ticker: "SNOW",
                shares: 0,
                close: 113.52,
                totalshares: 15,
                marketvalue: 1702.80,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-09",
                ticker: "SNOW",
                shares: 0,
                close: 119.67,
                totalshares: 15,
                marketvalue: 1795.05,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-10",
                ticker: "SNOW",
                shares: 0,
                close: 123.79,
                totalshares: 15,
                marketvalue: 1856.85,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-11",
                ticker: "SNOW",
                shares: 0,
                close: 124.03,
                totalshares: 15,
                marketvalue: 1860.45,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-14",
                ticker: "SNOW",
                shares: 0,
                close: 123.16,
                totalshares: 15,
                marketvalue: 1847.40,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-15",
                ticker: "SNOW",
                shares: 0,
                close: 122.74,
                totalshares: 15,
                marketvalue: 1841.10,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-16",
                ticker: "SNOW",
                shares: 0,
                close: 118.90,
                totalshares: 15,
                marketvalue: 1783.50,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-17",
                ticker: "SNOW",
                shares: 0,
                close: 119.03,
                totalshares: 15,
                marketvalue: 1785.45,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-18",
                ticker: "SNOW",
                shares: 0,
                close: 119.54,
                totalshares: 15,
                marketvalue: 1793.10,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-21",
                ticker: "SNOW",
                shares: 0,
                close: 119.56,
                totalshares: 15,
                marketvalue: 1793.40,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-22",
                ticker: "SNOW",
                shares: 0,
                close: 115.50,
                totalshares: 15,
                marketvalue: 1732.50,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-23",
                ticker: "SNOW",
                shares: 0,
                close: 113.61,
                totalshares: 15,
                marketvalue: 1704.15,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-24",
                ticker: "SNOW",
                shares: 0,
                close: 114.92,
                totalshares: 15,
                marketvalue: 1723.80,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-25",
                ticker: "SNOW",
                shares: 0,
                close: 116.04,
                totalshares: 15,
                marketvalue: 1740.60,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-28",
                ticker: "SNOW",
                shares: 0,
                close: 117.33,
                totalshares: 15,
                marketvalue: 1759.95,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-29",
                ticker: "SNOW",
                shares: 0,
                close: 118.39,
                totalshares: 15,
                marketvalue: 1775.85,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-30",
                ticker: "SNOW",
                shares: 0,
                close: 118.99,
                totalshares: 15,
                marketvalue: 1784.85,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-10-31",
                ticker: "SNOW",
                shares: 0,
                close: 114.82,
                totalshares: 15,
                marketvalue: 1722.30,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-01",
                ticker: "SNOW",
                shares: 0,
                close: 115.49,
                totalshares: 15,
                marketvalue: 1732.35,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-04",
                ticker: "SNOW",
                shares: 0,
                close: 113.74,
                totalshares: 15,
                marketvalue: 1706.10,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-05",
                ticker: "SNOW",
                shares: 0,
                close: 116.50,
                totalshares: 15,
                marketvalue: 1747.50,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-06",
                ticker: "SNOW",
                shares: 0,
                close: 121.42,
                totalshares: 15,
                marketvalue: 1821.30,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-07",
                ticker: "SNOW",
                shares: 0,
                close: 123.54,
                totalshares: 15,
                marketvalue: 1853.10,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-08",
                ticker: "SNOW",
                shares: 0,
                close: 120.89,
                totalshares: 15,
                marketvalue: 1813.35,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-11",
                ticker: "SNOW",
                shares: 0,
                close: 123.50,
                totalshares: 15,
                marketvalue: 1852.50,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-12",
                ticker: "SNOW",
                shares: 0,
                close: 125.46,
                totalshares: 15,
                marketvalue: 1881.90,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-13",
                ticker: "SNOW",
                shares: 0,
                close: 130.73,
                totalshares: 15,
                marketvalue: 1960.95,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-14",
                ticker: "SNOW",
                shares: 0,
                close: 129.27,
                totalshares: 15,
                marketvalue: 1939.05,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-15",
                ticker: "SNOW",
                shares: 0,
                close: 125.96,
                totalshares: 15,
                marketvalue: 1889.40,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-18",
                ticker: "SNOW",
                shares: 0,
                close: 127.43,
                totalshares: 15,
                marketvalue: 1911.45,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-19",
                ticker: "SNOW",
                shares: 0,
                close: 130.24,
                totalshares: 15,
                marketvalue: 1953.60,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-20",
                ticker: "SNOW",
                shares: 0,
                close: 129.12,
                totalshares: 15,
                marketvalue: 1936.80,
                cf: 0,
                transactions_type: "na"
            },
            {
                date: "2024-11-21",
                ticker: "SNOW",
                shares: -15,
                close: 171.35,
                totalshares: 0,
                marketvalue: 0.00,
                cf: 2601.17,
                transaction_type: "Sell"
            }
        ];

        /**
         * Processes the stock data to extract a series of cash flows for IRR calculation.
         * @param {Array<Object>} data - The array of stock data objects.
         * @returns {Array<number>} An array of cash flows.
         */
        function getCashFlows(data) {
            if (!data || data.length === 0) {
                return [];
            }

            // The first cash flow is the initial market value, as an outflow (negative).
            const initialInvestment = -data[0].marketvalue;
            const cashFlows = [initialInvestment];

            // Loop through the rest of the data to find intermediate and final cash flows.
            for (let i = 1; i < data.length; i++) {
                cashFlows.push(data[i].cf);
            }

            return cashFlows;
        }

        // Generate the cash flows from the stock data
        const cashFlows = getCashFlows(stockData);
        console.log("Generated Cash Flows:", cashFlows);
    </script>
</body>
</html>
